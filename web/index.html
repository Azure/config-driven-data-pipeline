<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Config Driven Data Pipeline</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.1/css/bootstrap.min.css"
        integrity="sha512-siwe/oXMhSjGCwLn+scraPOWrJxHlUgMBMZXdPe2Tnk3I0x3ESCoLz7WZ5NTH6SZrywMY+PB1cjyqJ5jAluCOg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.css"
        integrity="sha512-uf06llspW44/LZpHzHT6qBOIVODjWtv4MxCricRxkzvopAlSWnTf6hpZTFxuuZcuNE9CBQhqE0Seu1CoRk84nQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/theme/material.min.css"
        integrity="sha512-jA21084nir3cN96YuzJ1DbtDn30kxhxqQToAzCEGZcuRAswWfYirpUu8HVm8wRNoWDCYtA4iavd2Rb1bQSLv7g=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        html,
        body,
        #app {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #main {
            padding-top: 60px;
            height: 100%;
            overflow: hidden;
        }

        #content-area {
            height: 100%;
            overflow: hidden;
        }

        .tab-content {
            height: 100%;
            overflow: hidden;
        }

        .tab-pane {
            height: 100%;
            padding-top: 10px;
            overflow: hidden;
        }

        #config-content-wrap {
            overflow: hidden;
            height: 100%;
            width: 100%
        }

        #config-content {
            overflow: hidden;
            height: 100%;
            width: 100%;
        }

        #configTabContent {
            height: calc(100% - 145px);
            overflow: hidden;
        }

        #config-ui-content-wrap {
            overflow: hidden;
            height: calc(100% - 60px);
            width: 100%;
        }

        #config-ui-content {
            overflow: hidden;
            height: 100%;
            width: 100%;
        }

        #config-ui-tab-wrap {
            overflow: hidden;
            height: 100%;
            width: 100%;
        }

        #config-ui-staging-tab-pane {
            overflow: hidden;
            height: 100%;
            width: 100%;
        }

        #config-ui-staging-content-wrap {
            overflow: auto;
            height: calc(100% - 120px);
            width: 100%;
        }

        #config-ui-staging-content {
            height: 100%;
            width: 100%;
            margin-bottom: 50px;
            margin-top: 10px;
        }


        #config-ui-standard-tab-pane {
            overflow: hidden;
            height: 100%;
            width: 100%;
        }

        #config-ui-standard-content-wrap {
            overflow: auto;
            height: calc(100% - 120px);
            width: 100%;
        }

        #config-ui-standard-content {
            height: 100%;
            width: 100%;
            margin-bottom: 50px;
            margin-top: 10px;
        }


        #config-ui-serving-tab-pane {
            overflow: hidden;
            height: 100%;
            width: 100%;
        }

        #config-ui-serving-content-wrap {
            overflow: auto;
            height: calc(100% - 120px);
            width: 100%;
        }

        #config-ui-serving-content {
            height: 100%;
            width: 100%;
            margin-bottom: 50px;
            margin-top: 10px;
        }

        #config-ui-preview-tab-pane {
            overflow: hidden;
            height: 100%;
            width: 100%;
        }

        #config-ui-preview-content-wrap {
            overflow: auto;
            height: calc(100% - 100px);
            width: 100%;
        }

        #config-ui-preview-content {
            height: 100%;
            width: 100%;
            text-align: center;
            vertical-align: middle;
        }







        #config-json-content-wrap {
            overflow: hidden;
            height: calc(100% - 60px);
            width: 100%;
        }

        #config-json-content {
            overflow: auto;
            height: 100%;
            width: 100%;
        }

        #my-content-wrap {
            overflow: hidden;
            height: 100%;
        }

        #my-content {
            overflow: auto;
            height: calc(100% - 50px);
        }



        #staging-tab-pane {
            overflow: auto;
        }

        #standardization-tab-pane {
            overflow: auto;
        }

        #serving-tab-pane {
            overflow: auto;
        }


        #deploy-content-wrap {
            overflow: hidden;
            height: 100%;
        }

        #deploy-content {
            overflow: auto;
            height: calc(100% - 100px);
        }
    </style>
</head>

<body>
    <div id="app">
        <nav class="navbar bg-light fixed-top">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1">Config-Driven Data Pipeline WebUI</span>
                <form class="d-flex" role="search">
                    <button class="btn btn-outline-primary btn-sm mx-2" type="button"
                        @click="openFile()">Import</button>
                    <button class="btn btn-outline-primary btn-sm mx-2" v-show="selectedPipeline" type="button"
                        @click="exportFile()">Export</button>
                    <select class="form-select form-select-sm me-2" placeholder="Pipeline Config File"
                        aria-label="select pipeline" v-model="selectedPipeline" @change="onPipelineChanged"
                        v-show="selectedPipeline">
                        <option v-for="pipeline in Object.keys(pipelines)" :key="pipeline" :value="pipeline">
                            {{pipeline}}</option>
                    </select>


                    <button type="button" class="btn-close btn-sm mt-1 mx-2" aria-label="Close"
                        v-show="selectedPipeline" @click="closeFile()"></button>
                </form>
            </div>
        </nav>
        <div class="container-fluid" id="main" v-show="selectedPipeline">
            <div id="content-area">


                <div id="config-content-wrap">

                    <div id="config-content" class="mx-2 px-2">


                        <div id="config-ui-content-wrap" v-show="!showCodeEditor">
                            <div id="config-ui-content" v-if="currentPipelineObject">

                                <div class="container-fluid" id="config-ui-tab-wrap">
                                    <ul class="nav nav-tabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="config-ui-general-tab"
                                                data-bs-toggle="tab" data-bs-target="#config-ui-general-tab-pane"
                                                type="button" role="tab" aria-controls="config-ui-general-tab-pane"
                                                aria-selected="true">General</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="config-ui-staging-tab" data-bs-toggle="tab"
                                                data-bs-target="#config-ui-staging-tab-pane" type="button" role="tab"
                                                aria-controls="config-ui-staging-tab-pane"
                                                aria-selected="false">Staging</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="config-ui-standard-tab" data-bs-toggle="tab"
                                                data-bs-target="#config-ui-standard-tab-pane" type="button" role="tab"
                                                aria-controls="config-ui-standard-tab-pane"
                                                aria-selected="false">Standardization</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="config-ui-serving-tab" data-bs-toggle="tab"
                                                data-bs-target="#config-ui-serving-tab-pane" type="button" role="tab"
                                                aria-controls="config-ui-serving-tab-pane"
                                                aria-selected="false">Serving</button>
                                        </li>
                                    </ul>
                                    <div class="tab-content" id="config-ui-tab-content">

                                        <div class="tab-pane fade show active" id="config-ui-general-tab-pane"
                                            role="tabpanel" aria-labelledby="config-ui-general-tab" tabindex="0">
                                            <div class="container-fluid " id="config-ui-general-content-wrap">
                                                <div class="mb-3">
                                                    <label for="pipelineNameField" class="form-label">Pipeline
                                                        name</label>
                                                    <input type="text" class="form-control form-control-sm"
                                                        id="pipelineNameField" v-model="currentPipelineObject['name']"
                                                        placeholder="Pipeline Name">
                                                </div>
                                                <div class="mb-3 ">
                                                    <label for="dbxURL" class="form-label">Databricks URL</label>
                                                    <input type="text" class="form-control form-control-sm" id="dbxURL"
                                                        readonly
                                                        value="https://adb-1983375824764129.9.azuredatabricks.net/">
                                                </div>
                                                <div class="mb-3 ">
                                                    <label for="dbxURL" class="form-label">Databricks Cluster ID</label>
                                                    <input type="text" class="form-control form-control-sm"
                                                        id="dbxClusterId" readonly value="0612-144733-vbcidmwo">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="dbxJobName" class="form-label">Databricks Job
                                                        Name</label>
                                                    <input type="text" class="form-control form-control-sm"
                                                        id="dbxJobName" v-model="dbxJobName" :value="dbxJobName">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="landingPath" class="form-label">Landing Zone Root
                                                        Directory</label>
                                                    <input type="text" class="form-control form-control-sm"
                                                        id="landingPath" v-model="landingPath" :value="landingPath">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="workingDir" class="form-label">Working Directory</label>
                                                    <input type="text" class="form-control form-control-sm"
                                                        id="workingDir" v-model="workingDir" :value="workingDir">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="config-ui-staging-tab-pane" role="tabpanel"
                                            aria-labelledby="config-ui-staging-tab" tabindex="1">
                                            <form class="row g-2 p-3 shadow-sm">
                                                <div class="col-6">
                                                    <select class="form-select form-select-sm"
                                                        aria-label=".form-select-sm example"
                                                        v-model="currentPipelineStagingTask">
                                                        <option
                                                            v-for="(task, taskIdx) in currentPipelineObject['staging']"
                                                            :key="taskIdx" :value="task">{{task['name']}}</option>
                                                    </select>
                                                </div>
                                                <div class="col-2">
                                                    <button type="button" class="btn btn-outline-primary  btn-sm"
                                                        @click="">Add</button>
                                                </div>

                                            </form>

                                            <div class="container-fluid my-3" id="config-ui-staging-content-wrap"
                                                v-if="currentPipelineStagingTask">
                                                <div id="config-ui-staging-content" class="p-2">
                                                    <form class="row g-3 border p-2">
                                                        <div class="col-6 mb-1">
                                                            <label for="config-ui-staging-name" class="form-label">Task
                                                                Name</label>
                                                            <input type="text" class="form-control form-control-sm"
                                                                id="config-ui-staging-name"
                                                                v-model="currentPipelineStagingTask['name']"
                                                                placeholder="Name">
                                                        </div>
                                                        <div class="col-6 mb-1">
                                                            <label for="config-ui-staging-target"
                                                                class="form-label">Output Target</label>
                                                            <input type="text" class="form-control form-control-sm"
                                                                id="config-ui-staging-target"
                                                                v-model="currentPipelineStagingTask['target']"
                                                                placeholder="Target">
                                                        </div>
                                                        <div class="col-6 mb-1">
                                                            <label for="config-ui-staging-format"
                                                                class="form-label">Input Type</label>
                                                            <select class="form-select  form-select-sm"
                                                                aria-label="Format"
                                                                v-model="currentPipelineStagingTask['format']"
                                                                id="config-ui-staging-format">
                                                                <option value="csv">CSV
                                                                </option>
                                                                <option value="json">JSON
                                                                </option>
                                                            </select>
                                                        </div>

                                                        <div class="col-6 mb-1">
                                                            <label for="config-ui-staging-type"
                                                                class="form-label">Process Type</label>
                                                            <select class="form-select form-select-sm" aria-label="Type"
                                                                v-model="currentPipelineStagingTask['type']"
                                                                id="config-ui-staging-type">
                                                                <option value="batch">Batch
                                                                </option>
                                                                <option value="streaming">
                                                                    Streaming
                                                                </option>
                                                            </select>
                                                        </div>

                                                        <div class="col-6 mb-1">
                                                            <label for="config-ui-staging-location"
                                                                class="form-label">Data Source Location</label>
                                                            <input type="text" class="form-control form-control-sm"
                                                                id="config-ui-staging-location"
                                                                v-model="currentPipelineStagingTask['location']"
                                                                placeholder="Location">
                                                        </div>

                                                        <div class="col-6 mb-1">
                                                            <label for="config-ui-staging-output"
                                                                class="form-label">Output Format</label>
                                                            <select class="form-select form-select-sm" multiple
                                                                aria-label="Output"
                                                                v-model="currentPipelineStagingTask['output']"
                                                                id="config-ui-staging-output">
                                                                <option value="table">Table
                                                                </option>
                                                                <option value="file">File
                                                                </option>
                                                                <option value="view">View
                                                                </option>
                                                            </select>
                                                        </div>




                                                        <div class="col-12 mb-1">
                                                            <label for="schema" class="form-label">Input Schema</label>
                                                            <div class="border px-2 pt-2">
                                                                <div class="input-group mb-2"
                                                                    v-for="(schemaItem,schemaIdx) in currentPipelineStagingTask['schema']['fields']">
                                                                    <input type="text"
                                                                        class="form-control form-control-sm"
                                                                        placeholder="Name" aria-label="Name"
                                                                        v-model="currentPipelineStagingTask['schema']['fields'][schemaIdx]['name']">
                                                                    <select class="form-select form-select-sm"
                                                                        aria-label="Type"
                                                                        v-model="currentPipelineStagingTask['schema']['fields'][schemaIdx]['type']">
                                                                        <option value="short">
                                                                            short
                                                                        </option>
                                                                        <option value="integer">
                                                                            integer
                                                                        </option>
                                                                        <option value="long">
                                                                            long
                                                                        </option>
                                                                        <option value="float">
                                                                            float
                                                                        </option>
                                                                        <option value="double">
                                                                            double
                                                                        </option>
                                                                        <option value="string">
                                                                            string
                                                                        </option>
                                                                        <option value="boolean">
                                                                            boolean
                                                                        </option>
                                                                        <option value="boolean">
                                                                            boolean
                                                                        </option>
                                                                        <option value="timestamp">
                                                                            timestamp
                                                                        </option>
                                                                        <option value="date">
                                                                            date
                                                                        </option>
                                                                    </select>
                                                                    <select class="form-select form-select-sm"
                                                                        aria-label="Nullable"
                                                                        v-model="currentPipelineStagingTask['schema']['fields'][schemaIdx]['nullable']">
                                                                        <option value="false">
                                                                            false
                                                                        </option>
                                                                        <option value="true">
                                                                            true
                                                                        </option>
                                                                    </select>

                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="mb-1">
                                                            <label for="config-ui-staging-sampledata"
                                                                class="form-label">Sample
                                                                Data</label>
                                                            <div class="input-group mb-3">
                                                                <input type="text" class="form-control form-control-sm"
                                                                    id="config-ui-staging-sampledata"
                                                                    :value="(sampleData[selectedPipeline]&&sampleData[selectedPipeline][currentPipelineStagingTask['name']])?sampleData[selectedPipeline][currentPipelineStagingTask['name']]['filename']:''">
                                                                <button class="btn btn-outline-success btn-sm"
                                                                    type="button"
                                                                    @click="importDataFile(currentPipelineStagingTask)">
                                                                    <span class="spinner-border spinner-border-sm"
                                                                        role="status" aria-hidden="true"
                                                                        v-show="currentPipelineStagingTaskIsRunning"></span>
                                                                    Import Data
                                                                </button>
                                                            </div>

                                                            <table class="table my-3 border"
                                                                v-if="results['staging'] && results['staging'][currentPipelineStagingTask['name']] && results['staging'][currentPipelineStagingTask['name']].length>0">
                                                                <thead>
                                                                    <tr>
                                                                        <th scope="col">#
                                                                        </th>
                                                                        <th scope="col"
                                                                            v-for="(col, colIdx) in Object.keys(results['staging'][currentPipelineStagingTask['name']][0])"
                                                                            :key="colIdx" v-html="col">
                                                                        </th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <tr v-for="(row, rowIdx) in results['staging'][currentPipelineStagingTask['name']]"
                                                                        :key="rowIdx">
                                                                        <th scope="row">
                                                                            {{rowIdx}}</th>
                                                                        <td v-for="(cell, cellIdx) in results['staging'][currentPipelineStagingTask['name']][rowIdx]"
                                                                            :key="cellIdx">
                                                                            {{cell}}</td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>

                                                        </div>
                                                    </form>
                                                </div>


                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="config-ui-standard-tab-pane" role="tabpanel"
                                            aria-labelledby="config-ui-standard-tab" tabindex="2">

                                            <form class="row g-2 p-3 shadow-sm">
                                                <div class="col-6">
                                                    <select class="form-select form-select-sm"
                                                        aria-label=".form-select-sm example"
                                                        v-model="currentPipelineStandardTask">
                                                        <option
                                                            v-for="(task, taskIdx) in currentPipelineObject['standard']"
                                                            :key="taskIdx" :value="task">{{task['name']}}</option>
                                                    </select>
                                                </div>
                                                <div class="col-2">
                                                    <button type="button" class="btn btn-outline-primary  btn-sm"
                                                        @click="">Add</button>
                                                </div>

                                            </form>
                                            <div class="container-fluid my-3" id="config-ui-standard-content-wrap"
                                                v-if="currentPipelineStandardTask">
                                                <div id="config-ui-standard-content" class="p-2">
                                                    <form class="row g-3 border p-2">
                                                        <div class="col-6 mb-1">
                                                            <label for="config-ui-standard-name" class="form-label">Task
                                                                Name</label>
                                                            <input type="text" class="form-control form-control-sm"
                                                                id="config-ui-standard-name"
                                                                v-model="currentPipelineStandardTask['name']"
                                                                placeholder="Name">
                                                        </div>
                                                        <div class="col-6 mb-1">
                                                            <label for="config-ui-standard-target"
                                                                class="form-label">Output Target</label>
                                                            <input type="text" class="form-control form-control-sm"
                                                                id="config-ui-standard-target"
                                                                v-model="currentPipelineStandardTask['target']"
                                                                placeholder="Target">
                                                        </div>
                                                        <div class="col-6 mb-1">
                                                            <label for="config-ui-standard-type"
                                                                class="form-label">Process Type</label>
                                                            <select class="form-select form-select-sm" aria-label="Type"
                                                                v-model="currentPipelineStandardTask['type']"
                                                                id="config-ui-standard-type">
                                                                <option value="batch">Batch
                                                                </option>
                                                                <option value="streaming">
                                                                    Streaming
                                                                </option>
                                                            </select>
                                                        </div>
                                                        <div class="col-6 mb-1">
                                                            <label for="config-ui-standard-output"
                                                                class="form-label">Output Format</label>
                                                            <select class="form-select form-select-sm" multiple
                                                                aria-label="Output"
                                                                v-model="currentPipelineStandardTask['output']"
                                                                id="config-ui-standard-output">
                                                                <option value="table">Table
                                                                </option>
                                                                <option value="file">File
                                                                </option>
                                                                <option value="view">View
                                                                </option>
                                                            </select>
                                                        </div>
                                                        <div class="col-12 mb-1">
                                                            <label for="config-ui-standard-sql"
                                                                class="form-label">SQL</label>

                                                            <textarea class="form-control form-control-sm"
                                                                v-model="currentPipelineStandardTask['sql']"
                                                                id="config-ui-standard-sql" rows="8">
                                                                            </textarea>
                                                            <button class="btn btn-sm btn-outline-primary mt-3"
                                                                type="button" @click="tryStandardTask(currentPipelineStandardTask)">
                                                                <span class="spinner-border spinner-border-sm"
                                                                    role="status" aria-hidden="true"
                                                                    v-show="currentPipelineStandardTaskIsRunning"></span>
                                                                Try It</button>


                                                            <table class="table my-3 border"
                                                                v-if="results['standard'] && results['standard'][currentPipelineStandardTask['name']] && results['standard'][currentPipelineStandardTask['name']].length>0">
                                                                <thead>
                                                                    <tr>
                                                                        <th scope="col">#
                                                                        </th>
                                                                        <th scope="col"
                                                                            v-for="(col, colIdx) in Object.keys(results['standard'][currentPipelineStandardTask['name']][0])"
                                                                            :key="colIdx" v-html="col">
                                                                        </th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <tr v-for="(row, rowIdx) in results['standard'][currentPipelineStandardTask['name']]"
                                                                        :key="rowIdx">
                                                                        <th scope="row">
                                                                            {{rowIdx}}</th>
                                                                        <td v-for="(cell, cellIdx) in results['standard'][currentPipelineStandardTask['name']][rowIdx]"
                                                                            :key="cellIdx">
                                                                            {{cell}}</td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>

                                                        </div>
                                                    </form>
                                                </div>
                                            </div>



                                        </div>
                                        <div class="tab-pane fade" id="config-ui-serving-tab-pane" role="tabpanel"
                                            aria-labelledby="config-ui-serving-tab" tabindex="3">

                                            <form class="row g-2 p-3 shadow-sm">
                                                <div class="col-6">
                                                    <select class="form-select form-select-sm"
                                                        aria-label=".form-select-sm example"
                                                        v-model="currentPipelineServingTask">
                                                        <option
                                                            v-for="(task, taskIdx) in currentPipelineObject['serving']"
                                                            :key="taskIdx" :value="task">{{task['name']}}</option>
                                                    </select>
                                                </div>
                                                <div class="col-6">
                                                    <button type="button" class="btn btn-outline-primary  btn-sm"
                                                        @click="">Add</button>
                                                </div>

                                            </form>

                                            <div class="container-fluid my-3" id="config-ui-serving-content-wrap"
                                                v-if="currentPipelineServingTask">
                                                <div id="config-ui-staging-content" class="p-2">
                                                    <form class="row g-3 border p-2">
                                                        <div class="col-6 mb-1">
                                                            <label for="config-ui-serving-name" class="form-label">Task
                                                                Name</label>
                                                            <input type="text" class="form-control form-control-sm"
                                                                id="config-ui-serving-name"
                                                                v-model="currentPipelineServingTask['name']"
                                                                placeholder="Name">
                                                        </div>
                                                        <div class="col-6 mb-1">
                                                            <label for="config-ui-serving-target"
                                                                class="form-label">Output Target</label>
                                                            <input type="text" class="form-control form-control-sm"
                                                                id="config-ui-serving-target"
                                                                v-model="currentPipelineServingTask['target']"
                                                                placeholder="Target">
                                                        </div>
                                                        <div class="col-6 mb-1">
                                                            <label for="config-ui-serving-type"
                                                                class="form-label">Process Type</label>
                                                            <select class="form-select form-select-sm" aria-label="Type"
                                                                v-model="currentPipelineServingTask['type']"
                                                                id="config-ui-serving-type">
                                                                <option value="batch">Batch
                                                                </option>
                                                                <option value="streaming">
                                                                    Streaming
                                                                </option>
                                                            </select>
                                                        </div>
                                                        <div class="col-6 mb-1">
                                                            <label for="config-ui-serving-output"
                                                                class="form-label">Output Format</label>
                                                            <select class="form-select form-select-sm" multiple
                                                                aria-label="Output"
                                                                v-model="currentPipelineServingTask['output']"
                                                                id="config-ui-serving-output">
                                                                <option value="table">Table
                                                                </option>
                                                                <option value="file">File
                                                                </option>
                                                                <option value="view">View
                                                                </option>
                                                            </select>
                                                        </div>
                                                        <div class="col-12 mb-1">
                                                            <label for="config-ui-serving-sql"
                                                                class="form-label">SQL</label>
                                                            <textarea class="form-control form-control-sm"
                                                                v-model="currentPipelineServingTask['sql']"
                                                                id="config-ui-serving-sql" rows="8">
                                                                            </textarea>
                                                            <button class="btn btn-sm btn-outline-primary mt-3"
                                                                type="button" @click="tryServingTask(currentPipelineServingTask)">
                                                                <span class="spinner-border spinner-border-sm"
                                                                    role="status" aria-hidden="true"
                                                                    v-show="currentPipelineServingTaskIsRunning"></span>
                                                                Try It</button>


                                                            <table class="table my-3 border"
                                                                v-if="results['serving'] && results['serving'][currentPipelineServingTask['name']] && results['serving'][currentPipelineServingTask['name']].length>0">
                                                                <thead>
                                                                    <tr>
                                                                        <th scope="col">#
                                                                        </th>
                                                                        <th scope="col"
                                                                            v-for="(col, colIdx) in Object.keys(results['serving'][currentPipelineServingTask['name']][0])"
                                                                            :key="colIdx" v-html="col">
                                                                        </th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <tr v-for="(row, rowIdx) in results['serving'][currentPipelineServingTask['name']]"
                                                                        :key="rowIdx">
                                                                        <th scope="row">
                                                                            {{rowIdx}}</th>
                                                                        <td v-for="(cell, cellIdx) in results['serving'][currentPipelineServingTask['name']][rowIdx]"
                                                                            :key="cellIdx">
                                                                            {{cell}}</td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>

                                                        </div>
                                                    </form>
                                                </div>
                                            </div>




                                        </div>


                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="config-json-content-wrap" v-show="showCodeEditor">
                            <div id="config-json-content"></div>
                        </div>


                        <div class="row mt-2 border-top">

                            <div class="col">
                                <div class="form-check form-switch mt-3">
                                    <input class="form-check-input" type="checkbox" role="switch"
                                        id="flexSwitchCheckDefault" @change="toggleCodeEditor()">
                                    <label class="form-check-label" for="flexSwitchCheckDefault">Code
                                        Editor</label>
                                </div>
                            </div>


                            <div class="col" style="text-align: right;">
                                <button type="button" class="btn btn-outline-primary btn btn-sm mt-2 mx-2"
                                    @click="showPreview()">
                                    Preview
                                </button>
                                <button class="btn btn-outline-primary btn btn-sm mt-2 mx-2" type="button"
                                    @click="deployPipeline(false)">
                                    <span class="spinner-border spinner-border-sm"
                                                                    role="status" aria-hidden="true"
                                                                    v-show="deployIsRunning"></span>
                                    Deploy</button>
                                <button class="btn btn-outline-primary btn btn-sm mt-2 mx-2" type="button"
                                    @click="deployPipeline(true)">
                                    <span class="spinner-border spinner-border-sm"
                                                                    role="status" aria-hidden="true"
                                                                    v-show="deployAndRunIsRunning"></span>
                                    Deploy & Run</button>
                            </div>

                        </div>

                    </div>

                </div>

            </div>
        </div>

        <div class="modal fade " id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true"
            style="height:100%;overflow:hidden">
            <div class="modal-dialog modal-fullscreen" style="height:100%;overflow:hidden">
                <div class="modal-content" style="height:100%;overflow:hidden">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="previewModalLabel">Pipeline Preview</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" style="height:100%;overflow:hidden">

                        <div class="container-fluid" style="height:100%;overflow:hidden">
                            <div class="row" style="height:100%;overflow:hidden">
                                <div class="col" style="text-align: center;height:100%;width:100%;overflow:auto">
                                    <vue-mermaid-string v-if="previewDiagram" :value="previewDiagram" />
                                </div>
                                <div class="col" style="height:100%;overflow:hidden">
                                    <div id="workflow-json-preview-area-wrap"
                                        style="height:100%;width:100%;overflow:hidden">
                                        <div id="workflow-json-preview-area"
                                            style="height:100%;width:100%;overflow:hidden">
                                            <pre class="border"
                                                style="height:100%;overflow:auto"><code>{{previewWorkflowJson}}</code></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.1/js/bootstrap.min.js"
        integrity="sha512-vyRAVI0IEm6LI/fVSv/Wq/d0KUfrg3hJq2Qz5FlfER69sf3ZHlOrsLriNm49FxnpUGmhx+TaJKwJ+ByTLKT+Yg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.js"
        integrity="sha512-Kpi2Sp2KpXM2S7aM0p+CwWhm8NuogI15GFPXCmgqAnFr5c86VBXuLEZu0IGBwGSdhhTW6148hP9KTcRMmrjuFQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/javascript/javascript.min.js"
        integrity="sha512-I6CdJdruzGtvDyvdO4YsiAq+pkWf2efgd1ZUSK2FnM/u2VuRASPC7GowWQrWyjxCZn6CT89s3ddGI+be0Ak9Fg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.7.10/vue.min.js"
        integrity="sha512-H8u5mlZT1FD7MRlnUsODppkKyk+VEiCmncej8yZW1k/wUT90OQon0F9DSf/2Qh+7L/5UHd+xTLrMszjHEZc2BA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"
        integrity="sha512-odNmoc1XJy5x1TMVMdC7EMs3IVdItLPlCeL5vSUPN2llYKMJ2eByTTAIiiuqLg+GdNr9hF6z81p27DArRFKT7A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script src="https://unpkg.com/vue-mermaid-string"></script>
    <script>

        var app = new Vue({
            el: '#app',
            data: {
                message: 'Hello Vue!',
                editor: null,
                pipelines: {},
                selectedPipeline: null,
                selectedPipelineTask: null,
                currentStage: null,
                currentTask: null,
                results: {},
                sampleData: {},
                workingDir: "",
                landingPath: "",
                dbxJobName: "",
                currentPipelineObject: null,
                showCodeEditor: false,
                currentPipelineStagingTask: null,
                currentPipelineStagingTaskIsRunning: false,
                currentPipelineStandardTask: null,
                currentPipelineStandardTaskIsRunning: false,
                currentPipelineServingTask: null,
                currentPipelineServingTaskIsRunning: false,
                deployIsRunning: false,
                deployAndRunIsRunning: false,
                previewModal: null,
                previewDiagram: null,
                previewWorkflowJson: ''
            },
            methods: {
                initEditor: function () {
                    var that = this
                    if (this.editor == null) {
                        this.editor = CodeMirror(window.document.getElementById("config-json-content"), {
                            lineNumbers: true,
                            autoRefresh: true,
                            mode: "javascript",
                            theme: "material",
                            foldGutter: true,
                        });
                        this.editor.on("blur", function () {
                            that.pipelines[that.selectedPipeline] = that.editor.getValue();
                            that.loadCurrentPipelineObject(that.editor.getValue())

                        })
                        this.editor.setSize("100%", "100%");
                        this.editor.refresh()
                    }
                },
                toggleCodeEditor() {
                    this.showCodeEditor = !this.showCodeEditor
                    var that = this
                    setTimeout(function () {
                        var json = JSON.stringify(that.currentPipelineObject, null, 2)
                        that.editor.setValue(json)
                        that.editor.refresh()
                        that.$forceUpdate();
                    }, 200)
                },
                loadCurrentPipelineObject(json) {
                    var obj = JSON.parse(json);
                    if (obj) {
                        this.currentPipelineObject = obj
                    }
                    this.$forceUpdate()
                },
                previewPipeline: function () {
                    var that = this
                    this.results = {}
                    this.$forceUpdate()
                    axios.post('/api/pipeline/preview', {
                        pipeline: this.currentPipeline,
                        sample_data: this.sampleData[this.selectedPipeline],
                        timeout: 30
                    })
                        .then(function (response) {
                            // console.log(response);                            
                            that.loadPipelineResult(response.data.working_dir)
                        })
                        .catch(function (error) {
                            console.log(error);
                            alert("Error: " + error);
                        });
                },
                loadPipelineResult: function (working_dir) {
                    var that = this
                    var stages = ["staging", "standard", "serving"]
                    stages.forEach(function (stage) {
                        if (that.currentPipeline[stage]) {
                            that.results[stage] = {}
                            Object.keys(that.currentPipeline[stage]).forEach(task => {
                                that.showPipelineResult(stage, task, working_dir)
                            })
                        }
                    })
                },
                showPipelineResult: function (stage, task, working_dir) {

                    var that = this
                    that.results[stage][task] = []
                    that.$forceUpdate()
                    axios.post('/api/pipeline/result', {
                        pipeline: this.currentPipeline,
                        stage: stage,
                        task: task,
                        working_dir: working_dir,
                        limit: 30
                    })
                        .then(function (response) {
                            that.results[stage][task] = response.data
                            that.$forceUpdate()

                        })
                        .catch(function (error) {
                            console.log(error);
                        });
                },
                tryStagingTask: function (task) {
                    var that = this
                    that.currentPipelineStagingTaskIsRunning = true
                    axios.post('/api/pipeline/staging/try', {
                        pipeline: this.currentPipeline,
                        sample_data: this.sampleData[this.selectedPipeline],
                        task: task['name'],
                        limit: 20,
                        timeout: 10
                    })
                        .then(function (response) {
                            console.log(response.data);
                            that.results["staging"] = that.results["staging"] || {}
                            that.results["staging"][task['name']] = response.data
                            that.currentPipelineStagingTaskIsRunning = false
                            that.$forceUpdate()

                        })
                        .catch(function (error) {
                            console.log(error);
                            that.currentPipelineStagingTaskIsRunning = false
                        });
                },
                tryStandardTask: function (task) {
                    var that = this
                    that.currentPipelineStandardTaskIsRunning = true
                    axios.post('/api/pipeline/standardization/try', {
                        pipeline: this.currentPipeline,
                        sample_data: this.sampleData[this.selectedPipeline],
                        task: task['name'],
                        limit: 20,
                        timeout: 10
                    })
                        .then(function (response) {
                            console.log(response.data);
                            that.results["standard"] = that.results["standard"] || {}
                            that.results["standard"][task['name']] = response.data
                            that.currentPipelineStandardTaskIsRunning = false
                            that.$forceUpdate()

                        })
                        .catch(function (error) {
                            console.log(error);
                            that.currentPipelineStandardTaskIsRunning = false
                        });
                },
                tryServingTask: function (task) {
                    var that = this
                    that.currentPipelineServingTaskIsRunning = true
                    axios.post('/api/pipeline/serving/try', {
                        pipeline: this.currentPipeline,
                        sample_data: this.sampleData[this.selectedPipeline],
                        task: task['name'],
                        limit: 20,
                        timeout: 10
                    })
                        .then(function (response) {
                            console.log(response.data);
                            that.results["serving"] = that.results["serving"] || {}
                            that.results["serving"][task['name']] = response.data
                            that.currentPipelineServingTaskIsRunning = false
                            that.$forceUpdate()

                        })
                        .catch(function (error) {
                            console.log(error);
                            that.currentPipelineServingTaskIsRunning = false
                        });
                },
                deployPipeline(runNow) {
                    var that = this
                    if(runNow) {
                        this.deployAndRunIsRunning = true
                    } else {
                        this.deployIsRunning = true
                    }
                    axios.post('/api/pipeline/deploy', {
                        pipeline: this.currentPipeline,
                        job_name: this.dbxJobName,
                        landing_path: this.landingPath,
                        working_dir: this.workingDir,
                        row_now: runNow
                    })
                        .then(function (response) {
                            alert("The data pipeline is deployed successfully!")
                            that.$forceUpdate()
                            if(runNow) {
                                that.deployAndRunIsRunning = false
                            } else {
                                that.deployIsRunning = false
                            }
                        })
                        .catch(function (error) {
                            console.log(error);
                            if(runNow) {
                                that.deployAndRunIsRunning = false
                            } else {
                                that.deployIsRunning = false
                            }
                        });
                },
                previewPipelineWorkflow() {
                    var that = this
                    that.previewWorkflowJson = ''
                    axios.post('/api/pipeline/workflow/preview', {
                        pipeline: this.currentPipeline,
                        job_name: this.dbxJobName,
                        landing_path: this.landingPath,
                        working_dir: this.workingDir
                    })
                        .then(function (response) {
                            that.previewWorkflowJson = JSON.stringify(response.data.json, null, 4)
                            that.$forceUpdate()
                        })
                        .catch(function (error) {
                            console.log(error);
                        });
                },
                openFile() {
                    var that = this
                    var func = function dispFile(contents, filename) {
                        // document.getElementById('config-content').innerHTML = contents
                        that.pipelines[filename] = contents;
                        that.selectedPipeline = filename;
                        that.loadCurrentPipelineObject(contents)
                        if (that.currentPipelineObject) {
                            if (that.currentPipelineObject['staging'] && that.currentPipelineObject['staging'].length > 0) {
                                that.currentPipelineStagingTask = that.currentPipelineObject['staging'][0]
                            }
                            if (that.currentPipelineObject['standard'] && that.currentPipelineObject['standard'].length > 0) {
                                that.currentPipelineStandardTask = that.currentPipelineObject['standard'][0]
                            }
                            if (that.currentPipelineObject['serving'] && that.currentPipelineObject['serving'].length > 0) {
                                that.currentPipelineServingTask = that.currentPipelineObject['serving'][0]
                            }
                        }
                        that.$forceUpdate();
                        setTimeout(function () {
                            that.editor.setValue(contents);
                            that.editor.refresh();
                            that.workingDir = "/FileStore/cddp_apps/" + that.currentPipelineName + "/"
                            that.landingPath = "/FileStore/cddp_apps/" + that.currentPipelineName + "/landing/"
                            that.dbxJobName = that.currentPipelineName + "_pipeline"
                            that.$forceUpdate();
                        }, 200)



                    }
                    readFile = function (e) {
                        var file = e.target.files[0];
                        if (!file) {
                            return;
                        }
                        var reader = new FileReader();
                        reader.onload = function (e) {
                            var contents = e.target.result;
                            fileInput.func(contents, file.name)
                            document.body.removeChild(fileInput)
                        }
                        reader.readAsText(file)
                    }
                    fileInput = document.createElement("input")
                    fileInput.type = 'file'
                    fileInput.style.display = 'none'
                    fileInput.onchange = readFile
                    fileInput.func = func
                    document.body.appendChild(fileInput)
                    that.clickElem(fileInput)
                },
                importDataFile(task) {
                    var that = this
                    var func = function dispFile(content, filename) {
                        that.sampleData[that.selectedPipeline] = that.sampleData[that.selectedPipeline] || {}
                        that.sampleData[that.selectedPipeline][task['name']] = {
                            filename: filename,
                            content: content
                        }
                        that.$forceUpdate();
                        that.tryStagingTask(task)
                    }
                    readDataFile = function (e) {
                        var file = e.target.files[0];
                        if (!file) {
                            return;
                        }
                        var reader = new FileReader();
                        reader.onload = function (e) {
                            var content = e.target.result;
                            fileInput.func(content, file.name)
                            document.body.removeChild(fileInput)
                        }
                        reader.readAsText(file)
                    }
                    fileInput = document.createElement("input")
                    fileInput.type = 'file'
                    fileInput.style.display = 'none'
                    fileInput.onchange = readDataFile
                    fileInput.func = func
                    document.body.appendChild(fileInput)
                    that.clickElem(fileInput)
                },
                closeFile() {
                    this.pipelines[this.selectedPipeline] = null;
                    delete this.pipelines[this.selectedPipeline];
                    if (Object.keys(this.pipelines).length > 0) {
                        this.selectedPipeline = Object.keys(this.pipelines)[0];
                    } else {
                        this.selectedPipeline = null;
                    }
                    this.onPipelineChanged()
                    this.$forceUpdate()

                },
                clickElem(elem) {
                    var eventMouse = window.document.createEvent("MouseEvents")
                    eventMouse.initMouseEvent("click", true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null)
                    elem.dispatchEvent(eventMouse)
                },
                onPipelineChanged() {
                    if (this.selectedPipeline) {
                        this.editor.setValue(this.pipelines[this.selectedPipeline]);
                        this.editor.refresh();
                        this.workingDir = "dbfs:/FileStore/cddp_apps/" + this.currentPipelineName + "/"
                        this.landingPath = "dnfs:/FileStore/cddp_apps/" + this.currentPipelineName + "/landing/"
                        this.dbxJobName = this.currentPipelineName + "_pipeline"

                    } else {
                        this.editor.setValue("");
                        this.editor.refresh();
                    }
                },
                onPipelineTaskChanged() {
                    if (this.selectedPipelineTask) {
                        this.currentStage = this.selectedPipelineTask[0]
                        this.currentTask = this.selectedPipelineTask[1]
                        this.showPipelineResult();
                    }

                },
                showPreview() {
                    var that = this
                    this.previewModal.show()
                    setTimeout(function () {
                        that.previewDiagram = that.buildDiagram()
                        that.previewPipelineWorkflow()
                        that.$forceUpdate();
                    }, 500)

                },
                buildDiagram() {

                    var md = ''
                    if (this.currentPipelineObject) {
                        var stagingNode = ['standard_gate{{Standardization Gate}}']
                        var stagingConn = []
                        this.currentPipelineObject["staging"].forEach(function (task) {
                            if (task['type'] == 'batch') {
                                stagingNode.push(task['name'] + "[" + task['name'] + "]")
                                stagingConn.push(task['name'] + " --> standard_gate")
                            } else {
                                stagingNode.push(task['name'] + "([" + task['name'] + "])")
                            }

                        })

                        var standardNode = ['serving_gate{{Serving Gate}}']
                        var standardConn = []
                        this.currentPipelineObject["standard"].forEach(function (task) {
                            if (task['type'] == 'batch') {
                                standardNode.push(task['name'] + "[" + task['name'] + "]")
                                standardConn.push(task['name'] + " --> serving_gate")
                            } else {
                                standardNode.push(task['name'] + "([" + task['name'] + "])")

                            }
                            standardConn.push("standard_gate --> " + task['name'])

                        })

                        standardConn.push("standard_gate --> serving_gate")

                        var servingNode = []
                        var servingConn = []
                        this.currentPipelineObject["serving"].forEach(function (task) {
                            if (task['type'] == 'batch') {
                                servingNode.push(task['name'] + "[" + task['name'] + "]")
                            } else {
                                servingNode.push(task['name'] + "([" + task['name'] + "])")
                            }
                            servingConn.push("serving_gate --> " + task['name'])

                        })

                        var md = `graph TD
                        ${stagingNode.join('\n')}                    
                        ${standardNode.join('\n')}                   
                        ${servingNode.join('\n')}
                        ${standardConn.join('\n')}
                        ${stagingConn.join('\n')}
                        ${servingConn.join('\n')}`

                        console.log(md);

                        return md
                    } else {
                        return `graph TD`
                    }
                }
            },
            computed: {
                currentPipeline() {
                    if (this.selectedPipeline) {
                        var pipelineJSON = this.pipelines[this.selectedPipeline]
                        if (pipelineJSON) {
                            return JSON.parse(pipelineJSON)
                        }
                    }
                    return { "staging": {}, "standard": {}, "serving": {} }
                },
                currentPipelineStagingTasks() {
                    if (this.currentPipeline["staging"]) {
                        return Object.keys(this.currentPipeline["staging"])
                    } else {
                        return []
                    }

                },
                currentPipelineStardardTasks() {
                    if (this.currentPipeline["standard"]) {
                        return Object.keys(this.currentPipeline["standard"])
                    } else {
                        return []
                    }
                },
                currentPipelineServingTasks() {
                    if (this.currentPipeline["serving"]) {
                        return Object.keys(this.currentPipeline["serving"])
                    } else {
                        return []
                    }
                },
                currentPipelineName() {
                    if (this.selectedPipeline) {
                        return this.currentPipeline.name
                    } else {
                        return null;
                    }
                },

            },
            mounted: function () {
                this.initEditor();
                this.previewModal = new bootstrap.Modal('#previewModal', {
                    keyboard: false
                })
                var that = this
            }
        })


    </script>
</body>

</html>